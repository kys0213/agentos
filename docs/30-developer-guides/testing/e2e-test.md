# E2E Test Convention (Playwright)

## Ï†ÅÏö© ÎåÄÏÉÅ

- `apps/gui/e2e/*` - Playwright Í∏∞Î∞ò Ïõπ GUI E2E ÌÖåÏä§Ìä∏
- ÏÇ¨Ïö©Ïûê ÏãúÎÇòÎ¶¨Ïò§ Í∏∞Î∞ò ÌÜµÌï© ÌÖåÏä§Ìä∏
- Ïã§Ï†ú Î∏åÎùºÏö∞Ï†Ä ÌôòÍ≤ΩÏóêÏÑú Ï†ÑÏ≤¥ ÌîåÎ°úÏö∞ Í≤ÄÏ¶ù

## ÌÖåÏä§Ìä∏ Ï≤†Ìïô

### E2E ÌÖåÏä§Ìä∏ Î™©Ï†Å

- **ÏÇ¨Ïö©Ïûê Í¥ÄÏ†ê Í≤ÄÏ¶ù**: Ïã§Ï†ú ÏÇ¨Ïö©ÏûêÍ∞Ä Í≤ΩÌóòÌïòÎäî ÌîåÎ°úÏö∞
- **ÌÜµÌï© Í≤ÄÏ¶ù**: ÌîÑÎ°†Ìä∏ÏóîÎìú + Î∞±ÏóîÎìú + IPC Ï†ÑÏ≤¥ Ïä§ÌÉù
- **ÌöåÍ∑Ä Î∞©ÏßÄ**: Ï£ºÏöî ÏãúÎÇòÎ¶¨Ïò§Í∞Ä Ïó¨Ï†ÑÌûà ÏûëÎèôÌïòÎäîÏßÄ ÌôïÏù∏

### E2E vs Unit ÌÖåÏä§Ìä∏

| Ìï≠Î™© | Unit Test | E2E Test |
|------|-----------|----------|
| Î≤îÏúÑ | Îã®Ïùº Ìï®Ïàò/ÌÅ¥ÎûòÏä§ | Ï†ÑÏ≤¥ ÏÇ¨Ïö©Ïûê ÌîåÎ°úÏö∞ |
| ÏÜçÎèÑ | Îπ†Î¶Ñ (ms) | ÎäêÎ¶º (Ï¥à) |
| ÏïàÏ†ïÏÑ± | ÎÜíÏùå | Ï§ëÍ∞Ñ (UI Î≥ÄÍ≤ΩÏóê Ï∑®ÏïΩ) |
| Mock | ÌïÑÏàò | ÏµúÏÜåÌôî |
| Î™©Ìëú | Î°úÏßÅ Í≤ÄÏ¶ù | ÏÇ¨Ïö©Ïûê Í≤ΩÌóò Í≤ÄÏ¶ù |

## Template 1: Í∏∞Î≥∏ ÏÇ¨Ïö©Ïûê ÌîåÎ°úÏö∞

```typescript
// apps/gui/e2e/chat-ux.e2e.test.ts
import { test, expect } from '@playwright/test';
import { openManagementView } from './utils/navigation';

test.describe('Chat UX end-to-end', () => {
  test('create agent and chat echo works', async ({ page }) => {
    // 1. ÌéòÏù¥ÏßÄ ÏßÑÏûÖ
    await page.goto('/');

    // 2. Í¥ÄÎ¶¨ Î∑∞ Ïó¥Í∏∞
    await openManagementView(page);

    // 3. Agent ÏÉùÏÑ± ÌîåÎ°úÏö∞
    const navSubagents = page.getByTestId('nav-subagents');
    await expect(navSubagents.first()).toBeVisible();
    await navSubagents.first().click();

    await page.getByTestId('btn-create-agent').click();

    // 4. Agent Ï†ïÎ≥¥ ÏûÖÎ†•
    const agentName = `PW Chat Agent ${Date.now()}`;
    await page.getByLabel(/Agent Name/i).fill(agentName);
    await page.getByLabel(/Description/i).fill('Agent for chat UX test');
    await page.getByRole('button', { name: 'Next: Category' }).click();

    // 5. Category ÏÑ†ÌÉù
    await page.getByRole('button', { name: /Development.*software engineering/i }).click();
    await page.getByRole('button', { name: 'Next: AI Config' }).click();

    // 6. AI ÏÑ§Ï†ï
    const promptArea = page.getByPlaceholder(
      "Enter the system prompt that guides your agent's behavior..."
    );
    await promptArea.fill('You are a helpful verifier bot.');

    // Bridge ÏÑ†ÌÉù (Ï°¥Ïû¨ÌïòÎäî Í≤ΩÏö∞)
    const bridgeSelect = page.getByLabel('LLM Bridge');
    if (await bridgeSelect.count()) {
      await bridgeSelect.click();
      const firstOption = page.locator('[role="option"]').first();
      if (await firstOption.count()) {
        await firstOption.click();
      }
    }

    // Model ÏÑ†ÌÉù (Ï°¥Ïû¨ÌïòÎäî Í≤ΩÏö∞)
    const modelSelect = page.getByLabel('Model');
    if (await modelSelect.count()) {
      await modelSelect.click();
      const firstModel = page.locator('[role="option"]').first();
      if (await firstModel.count()) {
        await firstModel.click();
      }
    }

    // 7. Agent ÏÉùÏÑ± ÏôÑÎ£å
    await page.getByRole('button', { name: 'Next: Agent Settings' }).click();
    await page.getByRole('button', { name: 'Create Agent' }).click();
    await expect(page.getByText(agentName)).toBeVisible();

    // 8. Chat ÌÖåÏä§Ìä∏
    const navChat = page.getByTestId('nav-chat');
    if ((await navChat.count()) > 0) {
      await navChat.click();
    }

    const input = page.getByPlaceholder('Type a message...');
    await input.click();
    await input.fill('Hello from Playwright');
    await input.press('Enter');

    // 9. Echo ÏùëÎãµ ÌôïÏù∏
    await expect(page.getByText('Echo: Hello from Playwright')).toBeVisible({
      timeout: 5000,
    });
  });
});
```

## Template 2: Îã§Ï§ë Îã®Í≥Ñ ÌîåÎ°úÏö∞

```typescript
import { test, expect } from '@playwright/test';

test.describe('Subagent Creation Flow', () => {
  test('complete subagent creation with all steps', async ({ page }) => {
    // Setup
    await page.goto('/');

    // Step 1: ÏãúÏûë
    await page.getByTestId('btn-new-subagent').click();

    // Step 2: Í∏∞Î≥∏ Ï†ïÎ≥¥
    await page.getByLabel('Name').fill(`Test Agent ${Date.now()}`);
    await page.getByLabel('Description').fill('E2E test agent');
    await page.getByRole('button', { name: 'Next' }).click();

    // Step 3: Ïπ¥ÌÖåÍ≥†Î¶¨ ÏÑ†ÌÉù
    await page.getByRole('button', { name: /Development/i }).click();
    await page.getByRole('button', { name: 'Next' }).click();

    // Step 4: AI ÏÑ§Ï†ï
    await page.getByPlaceholder(/system prompt/i).fill('You are helpful.');
    await page.getByRole('button', { name: 'Next' }).click();

    // Step 5: ÏµúÏ¢Ö ÌôïÏù∏
    await page.getByRole('button', { name: 'Create' }).click();

    // Verification
    await expect(page.getByText(/Agent created/i)).toBeVisible();
  });

  test('cancel during creation returns to list', async ({ page }) => {
    await page.goto('/');

    await page.getByTestId('btn-new-subagent').click();
    await page.getByLabel('Name').fill('Will be cancelled');
    await page.getByRole('button', { name: 'Cancel' }).click();

    // Î¶¨Ïä§Ìä∏Î°ú ÎèåÏïÑÍ∞îÎäîÏßÄ ÌôïÏù∏
    await expect(page.getByTestId('subagent-list')).toBeVisible();
  });
});
```

## ÏÑ†ÌÉùÏûê Ïö∞ÏÑ†ÏàúÏúÑ (Selector Priority)

PlaywrightÏóêÏÑú ÏöîÏÜåÎ•º Ï∞æÏùÑ Îïå Îã§Ïùå ÏàúÏÑúÎ•º Îî∞Î¶ÖÎãàÎã§:

### 1ÏàúÏúÑ: Test ID (Í∞ÄÏû• ÏïàÏ†ïÏ†Å)

```typescript
// ‚úÖ Í∞ÄÏû• Í∂åÏû•
await page.getByTestId('btn-create-agent');
await page.getByTestId('nav-chat');
```

**Í∂åÏû• Ïù¥Ïú†:**
- UI ÌÖçÏä§Ìä∏ Î≥ÄÍ≤ΩÏóê ÏòÅÌñ• ÏóÜÏùå
- Îã§Íµ≠Ïñ¥ ÏßÄÏõêÏóê ÏïàÏ†ïÏ†Å
- Î™ÖÏãúÏ†ÅÏù∏ ÌÖåÏä§Ìä∏ ÏùòÎèÑ

### 2ÏàúÏúÑ: Role + Accessible Name

```typescript
// ‚úÖ Í∂åÏû•
await page.getByRole('button', { name: 'Create Agent' });
await page.getByRole('button', { name: /Next.*Category/i });
await page.getByLabel('Agent Name');
```

**Í∂åÏû• Ïù¥Ïú†:**
- Ï†ëÍ∑ºÏÑ± Ï§ÄÏàò ÏûêÎèô Í≤ÄÏ¶ù
- ÏÇ¨Ïö©ÏûêÍ∞Ä Î≥¥Îäî ÌÖçÏä§Ìä∏ Í∏∞Î∞ò
- ÏùòÎØ∏Î°†Ï†ÅÏúºÎ°ú Î™ÖÌôï

### 3ÏàúÏúÑ: Text Content

```typescript
// ü§î Í¥úÏ∞ÆÏùå (Í≥†Ïú†Ìïú ÌÖçÏä§Ìä∏Ïù∏ Í≤ΩÏö∞)
await page.getByText('Echo: Hello from Playwright');
await expect(page.getByText(agentName)).toBeVisible();
```

### 4ÏàúÏúÑ: CSS Selector (ÏßÄÏñë)

```typescript
// ‚ùå ÏßÄÏñë (Íµ¨Ï°∞ Î≥ÄÍ≤ΩÏóê Ï∑®ÏïΩ)
await page.locator('.btn-primary').click();
await page.locator('div > button:nth-child(2)').click();
```

**ÏÇ¨Ïö© Í∏àÏßÄ Ïù¥Ïú†:**
- CSS ÌÅ¥ÎûòÏä§ Î≥ÄÍ≤ΩÏóê Ï∑®ÏïΩ
- Íµ¨Ï°∞ Î≥ÄÍ≤Ω Ïãú Íπ®Ïßê
- ÏùòÎèÑÍ∞Ä Î∂àÎ™ÖÌôï

## ÎåÄÍ∏∞(Wait) Ï†ÑÎûµ

### Î™ÖÏãúÏ†Å ÎåÄÍ∏∞ (Í∂åÏû•)

```typescript
// ‚úÖ ÏöîÏÜåÍ∞Ä Î≥¥Ïùº ÎïåÍπåÏßÄ ÎåÄÍ∏∞
await expect(page.getByText('Success')).toBeVisible();

// ‚úÖ ÏöîÏÜåÍ∞Ä ÏÇ¨ÎùºÏßà ÎïåÍπåÏßÄ ÎåÄÍ∏∞
await expect(page.getByText('Loading...')).toBeHidden();

// ‚úÖ ÌÉÄÏûÑÏïÑÏõÉ ÏßÄÏ†ï
await expect(page.getByText('Slow response')).toBeVisible({ timeout: 10000 });

// ‚úÖ ÎÑ§Ìä∏ÏõåÌÅ¨ ÏùëÎãµ ÎåÄÍ∏∞
await page.waitForResponse((resp) => resp.url().includes('/api/agents'));
```

### ÏïîÎ¨µÏ†Å ÎåÄÍ∏∞ (ÏßÄÏñë)

```typescript
// ‚ùå Í≥†Ï†ï ÏãúÍ∞Ñ ÎåÄÍ∏∞ (ÎπÑÌö®Ïú®Ï†Å)
await page.waitForTimeout(3000);

// ‚ùå ÎÑàÎ¨¥ ÏßßÏùÄ ÌÉÄÏûÑÏïÑÏõÉ
await expect(element).toBeVisible({ timeout: 100 });
```

## Îç∞Ïù¥ÌÑ∞ Ï†ïÎ¶¨ (Cleanup)

### ÌÖåÏä§Ìä∏Î≥Ñ Í≤©Î¶¨

```typescript
test.describe('Agent Management', () => {
  test.beforeEach(async ({ page }) => {
    // Í∞Å ÌÖåÏä§Ìä∏ÎßàÎã§ Ï¥àÍ∏∞ ÏÉÅÌÉú
    await page.goto('/');
    await clearAllAgents(page);
  });

  test.afterEach(async ({ page }) => {
    // ÌÖåÏä§Ìä∏ ÌõÑ Ï†ïÎ¶¨
    await clearAllAgents(page);
  });

  test('creates agent', async ({ page }) => {
    // Íπ®ÎÅóÌïú ÏÉÅÌÉúÏóêÏÑú ÏãúÏûë
  });
});
```

### ÌÖåÏä§Ìä∏ Îç∞Ïù¥ÌÑ∞ Ï†ÑÎûµ

```typescript
// ‚úÖ Í≥†Ïú† Îç∞Ïù¥ÌÑ∞ ÏÉùÏÑ±
const agentName = `Test Agent ${Date.now()}`;
const uniqueId = `agent-${Math.random().toString(36)}`;

// ‚úÖ ÌÖåÏä§Ìä∏ ÌõÑ ÏÉùÏÑ±Îêú Îç∞Ïù¥ÌÑ∞ ÏÇ≠Ï†ú
test('creates and deletes agent', async ({ page }) => {
  const agentName = `Temp Agent ${Date.now()}`;

  // Create
  await createAgent(page, agentName);

  // Use
  await expect(page.getByText(agentName)).toBeVisible();

  // Delete
  await deleteAgent(page, agentName);
});
```

## Utils Ìï®Ïàò ÌôúÏö©

### Navigation Utils

```typescript
// apps/gui/e2e/utils/navigation.ts
import type { Page } from '@playwright/test';

export async function openManagementView(page: Page): Promise<void> {
  const navSettings = page.getByTestId('nav-settings');
  if ((await navSettings.count()) > 0) {
    await navSettings.click();
  }
}

export async function navigateToChat(page: Page): Promise<void> {
  const navChat = page.getByTestId('nav-chat');
  await navChat.click();
  await page.waitForURL('**/chat');
}

export async function navigateToSubagents(page: Page): Promise<void> {
  await page.getByTestId('nav-subagents').click();
  await page.waitForURL('**/subagents');
}
```

### Agent Utils

```typescript
// apps/gui/e2e/utils/agent.ts
import type { Page } from '@playwright/test';

export interface AgentConfig {
  name: string;
  description: string;
  category: string;
  systemPrompt: string;
}

export async function createAgent(
  page: Page,
  config: AgentConfig
): Promise<void> {
  await page.getByTestId('btn-create-agent').click();

  await page.getByLabel('Agent Name').fill(config.name);
  await page.getByLabel('Description').fill(config.description);
  await page.getByRole('button', { name: 'Next: Category' }).click();

  await page.getByRole('button', { name: new RegExp(config.category, 'i') }).click();
  await page.getByRole('button', { name: 'Next: AI Config' }).click();

  await page.getByPlaceholder(/system prompt/i).fill(config.systemPrompt);
  await page.getByRole('button', { name: 'Create Agent' }).click();

  await page.waitForURL('**/agents/*');
}

export async function deleteAgent(page: Page, agentName: string): Promise<void> {
  await page.getByText(agentName).click();
  await page.getByTestId('btn-delete-agent').click();
  await page.getByRole('button', { name: 'Confirm' }).click();
}
```

## Ïä§ÌÅ¨Î¶∞ÏÉ∑ Î∞è ÎîîÎ≤ÑÍπÖ

```typescript
test('debug failing test', async ({ page }) => {
  // Í∞Å Îã®Í≥ÑÎßàÎã§ Ïä§ÌÅ¨Î¶∞ÏÉ∑
  await page.goto('/');
  await page.screenshot({ path: 'screenshots/step1-home.png' });

  await page.getByTestId('btn-create').click();
  await page.screenshot({ path: 'screenshots/step2-form.png' });

  // Ï†ÑÏ≤¥ ÌéòÏù¥ÏßÄ Ïä§ÌÅ¨Î¶∞ÏÉ∑
  await page.screenshot({ path: 'screenshots/full-page.png', fullPage: true });

  // ÌäπÏ†ï ÏöîÏÜåÎßå
  const element = page.getByTestId('result');
  await element.screenshot({ path: 'screenshots/element.png' });
});
```

## ÎÑ§Ìä∏ÏõåÌÅ¨ Í≤ÄÏ¶ù

```typescript
test('verifies API calls', async ({ page }) => {
  // API ÏùëÎãµ ÎåÄÍ∏∞
  const responsePromise = page.waitForResponse(
    (resp) => resp.url().includes('/api/agents') && resp.status() === 200
  );

  await page.getByTestId('btn-create-agent').click();

  const response = await responsePromise;
  const data = await response.json();

  expect(data).toHaveProperty('id');
  expect(data.status).toBe('created');
});

test('handles API errors gracefully', async ({ page }) => {
  // API ÏóêÎü¨ ÏãúÎÆ¨Î†àÏù¥ÏÖò
  await page.route('**/api/agents', (route) => {
    route.fulfill({
      status: 500,
      body: JSON.stringify({ error: 'Server error' }),
    });
  });

  await page.getByTestId('btn-create-agent').click();

  // ÏóêÎü¨ Î©îÏãúÏßÄ ÌëúÏãú ÌôïÏù∏
  await expect(page.getByText(/error/i)).toBeVisible();
});
```

## Î≥ëÎ†¨ Ïã§Ìñâ Í≥†Î†§ÏÇ¨Ìï≠

```typescript
// playwright.config.ts
export default defineConfig({
  // Î≥ëÎ†¨ Ïã§Ìñâ ÏÑ§Ï†ï
  workers: process.env.CI ? 2 : 4,

  // ÌÖåÏä§Ìä∏ Í∞Ñ Í≤©Î¶¨
  fullyParallel: true,

  // Ïû¨ÏãúÎèÑ ÏÑ§Ï†ï
  retries: process.env.CI ? 2 : 0,
});
```

### Î≥ëÎ†¨ ÏïàÏ†Ñ ÌÖåÏä§Ìä∏ ÏûëÏÑ±

```typescript
// ‚úÖ Í≥†Ïú†Ìïú Îç∞Ïù¥ÌÑ∞Î°ú Ï∂©Îèå Î∞©ÏßÄ
test('parallel safe', async ({ page }) => {
  const uniqueName = `Agent ${Date.now()}-${Math.random()}`;
  await createAgent(page, { name: uniqueName });
});

// ‚ùå Í≥µÏú† ÏÉÅÌÉú ÏÇ¨Ïö© (Î≥ëÎ†¨ Ïã§Ìñâ Ïãú Ï∂©Îèå)
test('not parallel safe', async ({ page }) => {
  await createAgent(page, { name: 'Fixed Name' }); // Ï∂©Îèå Í∞ÄÎä•
});
```

## Ïã§Ìñâ Î™ÖÎ†πÏñ¥

```bash
# Ï†ÑÏ≤¥ E2E ÌÖåÏä§Ìä∏
pnpm --filter @agentos/apps-gui test:e2e

# Headed Î™®Îìú (Î∏åÎùºÏö∞Ï†Ä Î≥¥Ïù¥Í∏∞)
pnpm --filter @agentos/apps-gui test:e2e -- --headed

# ÌäπÏ†ï ÌååÏùºÎßå
pnpm --filter @agentos/apps-gui test:e2e chat-ux.e2e.test.ts

# Debug Î™®Îìú
pnpm --filter @agentos/apps-gui test:e2e -- --debug

# UI Î™®Îìú (Ïù∏ÌÑ∞ÎûôÌã∞Î∏å)
pnpm --filter @agentos/apps-gui test:e2e -- --ui
```

## Ï≤¥ÌÅ¨Î¶¨Ïä§Ìä∏

E2E ÌÖåÏä§Ìä∏ ÏûëÏÑ± Ïãú ÌôïÏù∏ÏÇ¨Ìï≠:

- [ ] ÏÇ¨Ïö©Ïûê ÏãúÎÇòÎ¶¨Ïò§Í∞Ä Î™ÖÌôïÌïúÍ∞Ä?
- [ ] Test IDÎ•º Ïö∞ÏÑ† ÏÇ¨Ïö©ÌñàÎäîÍ∞Ä?
- [ ] Í≥†Ï†ï ÎåÄÍ∏∞(waitForTimeout) ÏóÜÏù¥ ÏûëÏÑ±ÌñàÎäîÍ∞Ä?
- [ ] ÌÖåÏä§Ìä∏ Îç∞Ïù¥ÌÑ∞Í∞Ä Í≥†Ïú†ÌïúÍ∞Ä? (Î≥ëÎ†¨ Ïã§Ìñâ ÏïàÏ†Ñ)
- [ ] ÏÑ±Í≥µ/Ïã§Ìå® ÏºÄÏù¥Ïä§ Î™®Îëê Ïª§Î≤ÑÌñàÎäîÍ∞Ä?
- [ ] Utils Ìï®ÏàòÎ°ú Ï§ëÎ≥µ Ï†úÍ±∞ÌñàÎäîÍ∞Ä?
- [ ] ÌÖåÏä§Ìä∏ ÌõÑ Ï†ïÎ¶¨(cleanup)Í∞Ä ÎêòÎäîÍ∞Ä?

## Ï∞∏Í≥† Î¨∏ÏÑú

- [Playwright Í≥µÏãù Î¨∏ÏÑú](https://playwright.dev)
- [Testing Guide](../../../docs/30-developer-guides/testing.md)
- [Electron E2E Test](./electron-e2e-test.md)
