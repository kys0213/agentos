# Shimmy 사이드카 프로세스 관리 체크리스트

## 개요
Shimmy 사이드카는 사용자가 온디바이스 모델 사용을 요청했을 때 즉시 기동되어야 하는 핵심 구성요소입니다. 프로세스 관리 로직에서 버그가 발생하면 전체 GUI/CLI 경험이 마비될 수 있으므로, 설계 단계에서부터 실패 시나리오를 체계적으로 다루어야 합니다. 아래 체크리스트는 구현 전에 반드시 검토해야 하는 핵심 안전장치를 정리합니다.

## 제어 추상화(Control Abstractions)
- **단일 진입점**: `ShimmyProcessManager`는 `start`, `stop`, `ensureReady`, `getPort` 등 주요 동작을 명확히 공개하고, 내부 구현 세부사항은 패키지 외부에 노출하지 않습니다.
- **상태 머신 기반 제어**: `idle → starting → ready → restarting → stopping` 등 상태 전이를 명시적으로 관리하여, 각 단계에서 허용되는 동작을 제한합니다.
- **협력 모듈 역할 분리**: 포트 탐색, 가속 감지, 모델 보장, 텔레메트리는 각각 독립 모듈로 구현하여 테스트와 재사용성을 높입니다.
- **이벤트 브리지**: 각 상태 전환, 오류, 자원 변화는 이벤트 버스를 통해 GUI/CLI/텔레메트리로 전달하고, 동기/비동기 호출을 혼합할 때는 백프레셔 정책을 명확히 정의합니다.

## 시작(Start-up)
- **조건부 기동**: 애플리케이션 라이프사이클과 무관하게 항상 실행하지 말고, 사용자가 온디바이스 모델을 활성화했을 때만 사이드카를 기동합니다. 비활성 상태로 전환하면 안전하게 중단하여 자원을 회수합니다.
- **포트 스캐닝**: 기본 포트가 사용 중인 경우 최대 10회까지 증분 검색을 수행하고, 모든 후보가 점유된 경우 명확한 `PORT_IN_USE` 오류를 반환합니다.
- **사전 검증**: 실행 전에 모델 디렉터리 접근 권한과 필수 환경변수(`SHIMMY_MODELS_DIR`, `SHIMMY_LOG_LEVEL`) 구성이 정상인지 확인하여 조기 실패를 유도합니다.
- **가속 감지 연동**: `AccelDetector`가 산출한 권장 플래그를 `ShimmyProcessManager.start`에 안전하게 전달하고, 미지원일 경우 `UNSUPPORTED_ACCEL` 오류로 승격합니다.

## 헬스체크(Health Check)
- **타임아웃 관리**: `/v1/models` 호출이 기본 120초를 넘으면 즉시 프로세스를 종료하고 1회 재기동합니다.
- **로그 연동**: 헬스체크 실패 시 사이드카 표준출력/표준에러를 캡처하여 로그 뷰어와 텔레메트리에 전달합니다.
- **준비 신호 발행**: 성공 시 `shimmy_ready` 이벤트를 발행하여 GUI/CLI가 안전하게 요청을 라우팅하도록 합니다.

## 런타임 모니터링(Runtime)
- **크래시 감시**: 사이드카 프로세스가 비정상 종료되면 즉시 감지하여 최대 N회 자동 재시작하고, 반복 실패 시 사용자에게 명시적으로 알립니다.
- **자원 모니터링**: CPU/GPU 사용량과 메모리 소비량을 `telemetry` 패키지에 전송하여 대시보드와 로그에 노출합니다.
- **오프라인 모드 호환**: 네트워크가 차단된 환경에서도 헬스체크와 모델 로딩이 정상 동작하도록, 외부 네트워크 의존성이 없는지 상시 확인합니다.

## 종료(Shutdown)
- **온전한 종료 절차**: 애플리케이션 종료 시 SIGTERM을 전송하고 5초 이내 종료되지 않으면 SIGKILL로 강제 종료합니다.
- **정리 작업**: 종료 시 임시 파일, 잠금 파일, 소켓 등을 정리하여 다음 실행이 깨끗하게 시작되도록 보장합니다.

## 에러 보고(Error Handling)
- **코드 매핑**: 모든 오류는 `ShimmyErrorCode`로 정규화하여 GUI/CLI가 사용자 친화적인 메시지를 노출할 수 있게 합니다.
- **텔레메트리 이벤트**: 치명적 오류 발생 시 `error` 이벤트를 생성하여 세션과 연관된 진단 정보를 남깁니다.

### ShimmyErrorCode 매핑 가이드
| 코드 | 트리거 조건 | 기본 복구 절차 | 사용자 메시지 예시 |
| --- | --- | --- | --- |
| `PORT_IN_USE` | 선호 포트 및 백업 포트(최대 10회 시도)가 모두 점유됨 | 다음 사용 가능한 포트를 다시 검색하고, 모든 후보가 실패하면 프로세스 중단 | "다른 애플리케이션이 로컬 포트를 사용 중입니다. 사용 중인 앱을 종료하거나 설정에서 포트를 변경하세요." |
| `START_TIMEOUT` | shimmy 프로세스가 헬스체크 타임아웃(기본 120초) 내에 준비 완료 신호를 반환하지 않음 | 프로세스 종료 후 최대 1회 재시작, 재시도 실패 시 오류 노출 | "Shimmy가 예상 시간 내 기동하지 못했습니다. 모델 파일 또는 GPU 설정을 확인하세요." |
| `HEALTHCHECK_FAILED` | `/v1/models` 헬스체크 호출이 연속으로 실패하거나 비정상 응답 반환 | 표준출력/표준에러 로그 캡처 후 재기동, 반복 실패 시 사용자 알림 | "Shimmy 헬스체크에 실패했습니다. 로그를 열어 세부 원인을 확인하세요." |
| `MODEL_NOT_FOUND` | `defaultModel` 혹은 사용자 선택 모델이 modelsDir에 존재하지 않음 | 모델 다운로드 플로우 실행, 실패 시 라이선스 동의/네트워크 상태 확인 안내 | "선택한 모델이 설치되어 있지 않습니다. 다운로드를 진행해주세요." |
| `DOWNLOAD_FAILED` | 모델 다운로드가 네트워크 오류, 체크섬 불일치 등으로 중단됨 | 재시도(백오프), 캐시 정리 후 재다운로드 옵션 제공 | "모델 다운로드에 실패했습니다. 네트워크 연결을 확인한 뒤 다시 시도하세요." |
| `UNSUPPORTED_ACCEL` | 감지된 하드웨어가 요청된 가속 플래그(CUDA/Metal/MLX 등)를 지원하지 않음 | CPU 모드로 폴백하거나 사용자가 다른 가속 옵션을 선택하도록 유도 | "현재 장치에서 선택한 가속 옵션을 사용할 수 없습니다. 설정에서 다른 옵션을 선택하세요." |

> 위 매핑은 GUI/CLI 양쪽에서 동일한 에러 코드 → 복구 흐름 → 사용자 메시지 전략을 공유하기 위한 기준입니다. 각 채널은 문구 톤을 상황에 맞게 조정하되, 필수 정보(원인, 조치, 다음 단계)는 유지해야 합니다.

## 체크리스트 사용 방법
1. 새 기능 구현 전 위 항목을 기반으로 계획서를 작성하고, 테스트 시나리오에 반영합니다.
2. PR 리뷰 시 각 항목이 적절히 다뤄졌는지 확인합니다.
3. 회귀 테스트에 포트 충돌, 타임아웃, 재시작 루프, 오프라인 모드 등을 포함하여 안전성을 지속적으로 검증합니다.

위 내용을 준수하면 사이드카 프로세스 관련 치명적 장애를 예방하고, 신뢰성 높은 로컬 LLM 경험을 제공할 수 있습니다.
